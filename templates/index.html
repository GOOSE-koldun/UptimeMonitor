<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>{{ t.title }}</title>
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" href="/static/database.png" sizes="192x192">
    <style>
        body {
            background: #f8f9fa;
            color: #212529;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        
        .dark-mode {
            background: #121212;
            color: #e9ecef;
        }

        
        .dark-mode .card,
        .dark-mode table,
        .dark-mode .form-control,
        .dark-mode .input-group,
        .dark-mode .btn,
        .dark-mode .card-body,
        .dark-mode .table th,
        .dark-mode .table td {
            background: #1e1e1e !important;
            color: #e9ecef !important;
            border-color: #333 !important;
        }

        
        .dark-mode th,
        .dark-mode td,
        .dark-mode label,
        .dark-mode small,
        .dark-mode .text-muted {
            color: #b0b0b0 !important;
        }

        
        .dark-mode .btn-outline-primary {
            color: #4dabf7;
            border-color: #4dabf7;
        }
        .dark-mode .btn-outline-primary:hover {
            background: #4dabf7 !important;
            color: #121212 !important;
        }

        
        .status-up {
            border-left: 5px solid #28a745;
            border-radius: 6px 0 0 6px;
            transition: transform 0.2s;
        }
        .status-down {
            border-left: 5px solid #dc3545;
            border-radius: 6px 0 0 6px;
            transition: transform 0.2s;
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        .site-card {
            transition: transform 0.2s, box-shadow 0.2s, border-left 0.2s;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }
        .site-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
            border-color: #adb5bd;
        }

        /* –ë–µ–π–¥–∂–∏ (–æ–Ω–ª–∞–π–Ω/–æ—Ñ—Ñ–ª–∞–π–Ω) */
        .badge {
            font-size: 0.85em;
            padding: 0.5em 0.8em;
            border-radius: 6px;
            font-weight: 500;
        }
        .badge.bg-success { background: #28a745; color: white; }
        .badge.bg-danger { background: #dc3545; color: white; }
        .badge.bg-warning { background: #ffc107; color: #121212; }
        .badge.bg-info { background: #17a2b8; color: white; }
        .badge.bg-secondary { background: #6c757d; color: white; }

        /* –í —Ç—ë–º–Ω–æ–π —Ç–µ–º–µ ‚Äî –±–µ–π–¥–∂–∏ —Ç–æ–∂–µ —Ç–µ–º–Ω–µ–µ */
        .dark-mode .badge.bg-success { background: #218838; }
        .dark-mode .badge.bg-danger { background: #c82333; }
        .dark-mode .badge.bg-warning { background: #e0a800; }
        .dark-mode .badge.bg-info { background: #138496; }
        .dark-mode .badge.bg-secondary { background: #545b62; }

        /* –ì—Ä–∞—Ñ–∏–∫–∏ ‚Äî –±–µ–ª—ã–π —Ñ–æ–Ω –≤ —Å–≤–µ—Ç–ª–æ–π, —Ç—ë–º–Ω—ã–π –≤ —Ç—ë–º–Ω–æ–π */
        .chart-container {
            height: 250px;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 15px;
            transition: background 0.3s ease;
        }
        .dark-mode .chart-container {
            background: #1e1e1e;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* –§—É—Ç–µ—Ä */
        footer {
            margin-top: 50px;
            padding: 20px 0;
            color: #6c757d;
            text-align: center;
            border-top: 1px solid #eee;
            font-size: 0.9em;
        }
        .dark-mode footer {
            border-color: #333;
            color: #888;
        }

        /* –ö–Ω–æ–ø–∫–∞ —Ç—ë–º–Ω–æ–π —Ç–µ–º—ã */
        #darkModeBtn {
            background: #343a40;
            color: white;
            border: 1px solid #495057;
            transition: all 0.2s;
        }
        #darkModeBtn:hover {
            background: #495057;
            transform: scale(1.02);
        }
        .dark-mode #darkModeBtn {
            background: #f8f9fa;
            color: #121212;
            border: 1px solid #ced4da;
        }
        .dark-mode #darkModeBtn:hover {
            background: #e9ecef;
        }

        /* –ü–ª–∞–≤–Ω–∞—è —Å–º–µ–Ω–∞ —Ü–≤–µ—Ç–æ–≤ */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
    </style>
</head>
<body class="p-3">
    <div class="container-fluid">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-heartbeat text-danger"></i> {{ t.title }}</h1>
            <div class="d-flex flex-wrap gap-2">
                <a href="?lang=ru" class="btn btn-sm btn-outline-secondary {{ 'active' if lang == 'ru' else '' }}">üá∑üá∫ RU</a>
                <a href="?lang=en" class="btn btn-sm btn-outline-secondary {{ 'active' if lang == 'en' else '' }}">üá¨üáß EN</a>
                <button id="darkModeBtn" class="btn btn-outline-secondary">
                    <i class="fas fa-moon"></i> {{ t.dark_mode }}
                </button>
            </div>
        </div>

        <!-- Add Site -->
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <h5><i class="fas fa-plus-circle text-success"></i> {{ t.add_site }}</h5>
                <form method="POST" class="row g-3">
                    <div class="col-md-5">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-link"></i></span>
                            <input type="text" name="url" class="form-control" placeholder="{{ t.url }}" required>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-clock"></i></span>
                            <input type="number" name="interval" class="form-control" value="60" min="10" max="3600" placeholder="{{ t.interval }}">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" name="text" class="form-control" placeholder="{{ t.expected_text }}">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-save"></i> {{ t.save }}
                        </button>
                    </div>
                </form>
                <small class="text-muted mt-2 d-block">
                    üí° {{ t.tip }}: <code>http://[2001:db8::1]</code>
                </small>
            </div>
        </div>

        <!-- Sites List -->
        <div id="sitesList">
            {% for s in sites %}
            <div class="card mb-3 shadow-sm site-card status-{{ 'up' if s[5] == 1 else 'down' }}" data-id="{{ s[0] }}">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-7">
                            <h5 class="mb-1">
                                <a href="{{ s[1] }}" target="_blank" class="text-decoration-none">{{ s[1] }}</a>
                            </h5>
                            <p class="text-muted mb-1">
                                <strong>{{ t.expected_text }}:</strong> <code>{{ s[3] or '‚Äî' }}</code> |
                                <strong>{{ t.interval }}:</strong> {{ s[2] }} —Å
                            </p>
                            <p class="mb-0">
                                <span class="badge bg-{{ 'success' if s[5] == 1 else 'danger' }}">
                                    {{ 'üü¢ ' + t.online if s[5] == 1 else 'üî¥ ' + t.offline }}
                                </span>
                                {% if s[8] %}
                                    <span class="badge bg-info text-dark">‚è±Ô∏è {{ '%.1f'|format(s[8]) }}%</span>
                                {% endif %}
                                {% if s[6] %}
                                    <span class="badge bg-{{ 'success' if s[6] < 1 else 'warning' if s[6] < 3 else 'danger' }}">
                                        ‚è±Ô∏è {{ '%.3f'|format(s[6]) }} —Å
                                    </span>
                                {% endif %}
                            </p>
                            <small class="text-muted">
                                {{ t.last_check }}: {{ s[7].split('.')[0].replace('T', ' ') if s[7] else '‚Äî' }}
                            </small>
                        </div>
                        <div class="col-md-5 text-end">
                            <div class="btn-group" role="group">
                                <a href="/toggle/{{ s[0] }}" class="btn btn-sm {% if s[4] %}btn-warning{% else %}btn-secondary{% endif %}">
                                    {% if s[4] %}<i class="fas fa-pause"></i> {{ t.pause }}{% else %}<i class="fas fa-play"></i> {{ t.resume }}{% endif %}
                                </a>
                                <a href="/delete/{{ s[0] }}" class="btn btn-sm btn-danger" onclick="return confirm('{{ t.confirm_delete }}?')">
                                    <i class="fas fa-trash"></i>
                                </a>
                                <button class="btn btn-sm btn-info text-white" onclick="showChart({{ s[0] }})">
                                    <i class="fas fa-chart-line"></i> {{ t.chart }}
                                </button>
                            </div>
                            <div id="chart-{{ s[0] }}" class="chart-container d-none"></div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <footer>
            &copy; 2025 UptimeMonitor Pro ‚Äî <strong>{{ t.reliable_monitoring }}</strong>
        </footer>
    </div>

    <!-- Dark Mode + SSE + Charts -->
    <script>
        // –¢–µ–º–Ω–∞—è —Ç–µ–º–∞
        const darkModeBtn = document.getElementById('darkModeBtn');
        const body = document.body;

        function setDarkMode(enabled) {
            if (enabled) {
                body.classList.add('dark-mode');
                darkModeBtn.innerHTML = '<i class="fas fa-sun"></i> {{ t.light_mode }}';
            } else {
                body.classList.remove('dark-mode');
                darkModeBtn.innerHTML = '<i class="fas fa-moon"></i> {{ t.dark_mode }}';
            }
            localStorage.setItem('darkMode', enabled ? 'enabled' : 'disabled');
        }

        const saved = localStorage.getItem('darkMode');
        setDarkMode(saved === 'enabled');

        darkModeBtn.addEventListener('click', () => {
            setDarkMode(!body.classList.contains('dark-mode'));
        });

        // SSE + –∑–≤—É–∫
        const eventSource = new EventSource("/stream");
        const downSound = new Audio("https://zvukitop.com/wp-content/uploads/2021/08/oshybka-otvet4.mp3");
        const upSound = new Audio("https://www.soundjay.com/buttons/sounds/button-09.mp3");

        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            data.forEach(site => {
                const card = document.querySelector(`.site-card[data-id="${site.id}"]`);
                if (!card) return;

                const statusBadge = card.querySelector('.badge.bg-success, .badge.bg-danger');
                if (statusBadge) {
                    const isUp = site.status === "up";
                    statusBadge.textContent = isUp ? "üü¢ {{ t.online }}" : "üî¥ {{ t.offline }}";
                    statusBadge.className = `badge bg-${isUp ? 'success' : 'danger'}`;
                    card.classList.remove('status-up', 'status-down');
                    card.classList.add('status-' + (isUp ? 'up' : 'down'));

                    if (!isUp) downSound.play().catch(() => {});
                    else upSound.play().catch(() => {});
                }

                if (site.timestamp) {
                    const timeEl = card.querySelector('small.text-muted');
                    if (timeEl) timeEl.textContent = `{{ t.last_check }}: ${site.timestamp}`;
                }

                const rtBadge = card.querySelector('.badge.bg-secondary, .badge.bg-success, .badge.bg-warning, .badge.bg-danger');
                if (rtBadge && site.response_time) {
                    rtBadge.textContent = `‚è±Ô∏è ${site.response_time} —Å`;
                    rtBadge.className = `badge bg-${site.response_time < 1 ? 'success' : site.response_time < 3 ? 'warning' : 'danger'}`;
                }
            });
        };

        // –ì—Ä–∞—Ñ–∏–∫–∏
        let charts = {};
        function showChart(siteId) {
            const chartEl = document.getElementById(`chart-${siteId}`);
            chartEl.classList.toggle('d-none');
            if (chartEl.style.height !== '250px') chartEl.style.height = '250px';
            if (charts[siteId]) return;

            fetch(`/api/logs/${siteId}?days=7`)
                .then(r => r.json())
                .then(data => {
                    const ctx = chartEl.getContext('2d');
                    charts[siteId] = new Chart(ctx, {
                        type: 'line',
                        data: {
                            datasets: [{
                                label: '{{ t.response_time }} (—Å)',
                                data: data.map(d => ({ x: d.x, y: d.y })),
                                borderColor: '#007bff',
                                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                pointRadius: 3,
                                tension: 0.3
                            }]
                        },
                        options: {
                            plugins: { legend: { display: true } },
                            scales: {
                                y: { beginAtZero: true, title: { display: true, text: '{{ t.response_time }} (—Å)' } },
                                x: { title: { display: true, text: '{{ t.time }}' } }
                            }
                        }
                    });
                });
        }
    </script>
    
</body>
</html>